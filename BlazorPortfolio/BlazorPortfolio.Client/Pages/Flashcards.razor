@page "/flashcards"
@rendermode InteractiveWebAssembly
@using BlazorPorfolio.Models
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage


<h3>Flashcards</h3>
<p>Begin by adding flashcards to a set</p>



<EditForm Model="@newFlashcard" OnValidSubmit="@AddFlashcard">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="frontText" class="form-label">Front Text</label>
        <InputText id="frontText" class="form-control" @bind-Value="newFlashcard.FrontText" />
        <ValidationMessage For="@(() => newFlashcard.FrontText)" />

    </div>
    <div class="mb-3">
        <label for="backText" class="form-label">Back Text</label>
        <InputText id="backText" class="form-control" @bind-Value="newFlashcard.BackText" />
        <ValidationMessage For="@(() => newFlashcard.BackText)" />

    </div>
    <button type="submit" class="btn btn-primary">Submit</button>

</EditForm>


<br /> 

<InputText @bind-Value="flashcardSet.SetName" class="form-control" placeholder="Set Name" />
<button @onclick="SaveCurrentSet" class="btn btn-success">Save Set</button>
<button @onclick="LoadAllSets" class="btn btn-info">Load Set</button>





<br /><br />
<button class="btn btn-primary" @onclick="PlayCards">Study</button>
<br /><br />


@if (flashcardSet.Flashcards.Any())
{
    <h5>Flashcard Count: @flashcardSet.Flashcards.Count</h5>
    <ul>
        @foreach (var card in flashcardSet.Flashcards)
        {
            <li>
                @card.FrontText
            </li>
        }
    </ul> 
}
@if (allSets.Any())
{
    <h5>Set Count: @allSets.Count</h5>
    <ul>
        @foreach (var set in allSets)
        {
            <li>
                @set.SetName
            </li>
        }
    </ul>
}


@code {
    private Flashcard newFlashcard = new Flashcard();
    private FlashcardSet flashcardSet = new FlashcardSet();
    private List<FlashcardSet> allSets = new List<FlashcardSet>();

    private int nextId = 1;

    private void AddFlashcard()
    {
        newFlashcard.Id = nextId++;
        flashcardSet.Flashcards.Add(newFlashcard);
        newFlashcard = new Flashcard(); 
    }

    
    private async Task LoadFlashcards()
    {
        var loadedSet = await LocalStorage.GetItemAsync<FlashcardSet>("flashcardSet") ?? new FlashcardSet();
        flashcardSet = loadedSet;

        if (flashcardSet.Flashcards.Any())
        {
            nextId = flashcardSet.Flashcards.Max(fc => fc.Id) + 1;
        }
        else
        {
            nextId = 1;
        }
        StateHasChanged();
    }

    private async Task SaveCurrentSet()
    {
        // Check if the set name is unique or update an existing set
        var existingSet = allSets.FirstOrDefault(s => s.SetName == flashcardSet.SetName);
        if (existingSet == null)
        {
            allSets.Add(flashcardSet); // Add new set to the list
        }
        else
        {
            // Update an existing set
            existingSet.Flashcards = flashcardSet.Flashcards;
        }

        await SaveAllSets(); // Save all sets to local storage
        flashcardSet = new FlashcardSet(); // Reset for a new set
    }

    private async Task SaveAllSets()
    {
        await LocalStorage.SetItemAsync("allFlashcardSets", allSets);
    }

    private async Task LoadAllSets()
    {
        allSets = await LocalStorage.GetItemAsync<List<FlashcardSet>>("allFlashcardSets") ?? new List<FlashcardSet>();
    }


    private void PlayCards()
    {
        NavigationManager.NavigateTo("/Study");
    }
}

